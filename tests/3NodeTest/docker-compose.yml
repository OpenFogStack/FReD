version: "3.7"

services:
  tester:
    depends_on:
      - nodeA
      - nodeB
      - nodeC
      - etcd
    build:
      context: ../../../fred
      dockerfile: tester.Dockerfile
    image: fredtester:3nodetest
    container_name: tester
    command: '/go/bin/main --nodeAhost "172.26.0.10" --nodeAhttp 9001 --nodeBhost "172.26.0.11" --nodeBhttp 9001 --nodeChost "172.26.0.12" --nodeChttp 9001'
    networks:
      fredwork:
        ipv4_address: 172.26.2.1

  nodeA:
    depends_on:
      - etcd
      - storeA
    build: ../../../fred
    image: frednode:3nodetest
    container_name: nodeA
    volumes:
      - type: bind
        source: ./config.toml
        target: /etc/fredconfig.toml
        read_only: true
    command: --config "/etc/fredconfig.toml" --remote-storage-host "172.26.0.20" --zmq-host "172.26.0.10" --nodeID "nodeA"
    ports:
      - 9002:9001
    networks:
      fredwork:
        ipv4_address: 172.26.0.10

  storeA:
    build:
      context: ../../../fred
      dockerfile: storage-leveldb.Dockerfile
    image: fredstore:3nodetest
    container_name: storeA
    networks:
      fredwork:
        ipv4_address: 172.26.0.20

  nodeB:
    depends_on:
      - etcd
      - storeB
    image: frednode:3nodetest
    container_name: nodeB
    volumes:
      - type: bind
        source: ./config.toml
        target: /etc/fredconfig.toml
        read_only: true
    command: --config "/etc/fredconfig.toml" --remote-storage-host "172.26.0.21"  --zmq-host "172.26.0.11" --nodeID "nodeB"
    ports:
      - 9003:9001
    networks:
      fredwork:
        ipv4_address: 172.26.0.11

  storeB:
    image: fredstore:3nodetest
    container_name: storeB
    networks:
      fredwork:
        ipv4_address: 172.26.0.21

  nodeC:
    depends_on:
      - etcd
      - storeC
    image: frednode:3nodetest
    container_name: nodeC
    volumes:
      - type: bind
        source: ./config.toml
        target: /etc/fredconfig.toml
        read_only: true
    command: --config "/etc/fredconfig.toml"  --remote-storage-host "172.26.0.22"  --zmq-host "172.26.0.12" --nodeID "nodeC"
    ports:
      - 9004:9001
    networks:
      fredwork:
        ipv4_address: 172.26.0.12

  storeC:
    image: fredstore:3nodetest
    container_name: storeC
    networks:
      fredwork:
        ipv4_address: 172.26.0.22

  etcd:
    image: quay.io/coreos/etcd:v3.4.10
    container_name: etcd-1
    entrypoint: "etcd --name s-1 \
      --data-dir /tmp/etcd/s-1 \
      --listen-client-urls http://172.26.1.1:2379 \
      --advertise-client-urls http://172.26.1.1:2379 \
      --listen-peer-urls http://172.26.1.1:2380 \
      --initial-advertise-peer-urls http://172.26.1.1:2380 \
      --initial-cluster s-1=http://172.26.1.1:2380 \
      --initial-cluster-token tkn \
      --initial-cluster-state new"
    ports:
      - 2379:2379
      - 2380:2380
    networks:
      fredwork:
        ipv4_address: 172.26.1.1

networks:
  fredwork:
    external: true
# docker network create fredwork --gateway 172.26.0.1 --subnet 172.26.0.0/16
