image: gitlab-registry.tubit.tu-berlin.de/mcc-fred/fred/ci:latest

cache:
  paths:
    - .cache

stages:
  - test
  - build
  - release
  - test_aws

before_script:
  - mkdir -p .cache
  - export GOPATH="$CI_PROJECT_DIR/.cache"
  - export CC=clang
  - make dep

unit_tests:
  stage: test
  script:
    - make test

race_detector:
  stage: test
  script:
    - make race

memory_sanitizer:
  stage: test
  script:
    - make msan

code_coverage:
  stage: test
  script:
    - make coverage

code_coverage_report:
  stage: test
  script:
    - make coverhtml
  only:
    - master

lint_code:
  stage: test
  script:
    - make lint

build:
  stage: build
  script:
    - make

container:
  stage: release
  script:
    - make container
    - IFS='/' read -ra components <<< "$CI_COMMIT_REF_NAME"
    - CONTAINER_TAG=${components[0]}
    - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then CONTAINER_TAG=latest; fi;
    - echo $CONTAINER_TAG
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker tag gitlab-registry.tubit.tu-berlin.de/mcc-fred/fred/fred gitlab-registry.tubit.tu-berlin.de/mcc-fred/fred/fred:$CONTAINER_TAG
    - docker push gitlab-registry.tubit.tu-berlin.de/mcc-fred/fred/fred:$CONTAINER_TAG

terraform:
  stage: test_aws
  script:
    - cd terraform/small-test
    - TF_IN_AUTOMATION=true
    - CONTAINER_TAG=${components[0]}
    - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then CONTAINER_TAG=latest; fi;
    - terraform init -input=false
    - terraform plan -input=false -var="aws_access_key=$AWS_ACCESS_KEY" -var="aws_secret_key=$AWS_SECRET_KEY" -var="gitlab_repo_username=$CI_REGISTRY_USER" -var="gitlab_repo_password=$CI_REGISTRY_PASSWORD" -var="identifier=$CONTAINER_TAG"
